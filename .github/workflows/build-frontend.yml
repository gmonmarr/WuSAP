name: Deploy Backend & Frontend to SAP CF

on:
  push:
    branches: [sap-cf]  # Change if your default branch is different

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout Code
        uses: actions/checkout@v3

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: 18

      - name: â˜ï¸ Install Cloud Foundry CLI
        run: |
          curl -L "https://packages.cloudfoundry.org/stable?release=linux64" -o cf-cli.tgz
          tar -xzf cf-cli.tgz
          sudo mv cf /usr/local/bin
          cf version

      - name: ğŸ” Authenticate to SAP CF using service key
        env:
          CF_API: ${{ secrets.CF_API }}
          CF_CLIENT_ID: ${{ secrets.CF_CLIENT_ID }}
          CF_CLIENT_SECRET: ${{ secrets.CF_CLIENT_SECRET }}
          CF_AUTH_URL: ${{ secrets.CF_AUTH_URL }}
          CF_ORG: ${{ secrets.CF_ORG }}
          CF_SPACE: ${{ secrets.CF_SPACE }}
        run: |
          cf api $CF_API
          cf auth $CF_CLIENT_ID $CF_CLIENT_SECRET --client-credentials
          cf target -o $CF_ORG -s $CF_SPACE

      - name: ğŸš€ Deploy Backend (with environment variables)
        working-directory: backend
        env:
          HANA_SERVER_NODE: ${{ secrets.HANA_SERVER_NODE }}
          HANA_USER: ${{ secrets.HANA_USER }}
          HANA_PASSWORD: ${{ secrets.HANA_PASSWORD }}
          HANA_SCHEMA: ${{ secrets.HANA_SCHEMA }}
          JWT_SECRET: ${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION: ${{ secrets.JWT_EXPIRATION }}
        run: |
          npm install --omit=dev
          cf push

      - name: ğŸŒ Get Backend Route
        id: backend-url
        run: |
          BACKEND_ROUTE=$(cf app wusap-backend | grep routes: | awk '{print $2}')
          echo "BACKEND_URL=https://$BACKEND_ROUTE" >> $GITHUB_ENV
          echo "âœ… Backend URL is: https://$BACKEND_ROUTE"

      - name: ğŸ—ï¸ Build Frontend with dynamic backend URL
        working-directory: frontend
        run: |
          echo "VITE_API_SERVER=${{ env.BACKEND_URL }}" > .env.production
          npm install
          npm run build

      - name: ğŸŒ Deploy Frontend
        working-directory: frontend
        run: cf push
